#!/bin/bash
source config/settings.sh

# Fonction de nettoyage compl√®te des caract√®res Microsoft et retours ligne
clean_rakuten_text() {
    echo "$1" | \
    sed "s/'/ /g" | \
    sed "s/'/ /g" | \
    sed 's/"/ /g' | \
    sed 's/"/ /g' | \
    sed 's/¬´/ /g' | \
    sed 's/¬ª/ /g' | \
    sed 's/‚Ä¶/.../g' | \
    sed 's/‚Äî/-/g' | \
    sed 's/‚Äì/-/g' | \
    sed 's/\r\n/<br \/>/g' | \
    sed 's/\n/<br \/>/g' | \
    sed 's/\r/<br \/>/g' | \
    sed 's/;/,/g' | \
    sed 's/  */ /g' | \
    sed 's/^ *//;s/ *$//'
}

# Fonction de mapping des cat√©gories WordPress vers Rakuten
map_to_rakuten_category() {
    local category_path="$1"
    local mapping_file="config/rakuten_category_mapping.csv"
    
    if [ -f "$mapping_file" ]; then
        local mapped=$(grep -F "\"$category_path\"," "$mapping_file" | head -1 | cut -d',' -f2 | tr -d '"')
        if [ -n "$mapped" ]; then
            echo "$mapped"
            return
        fi
        
        local last_level=$(echo "$category_path" | rev | cut -d'>' -f1 | rev | xargs)
        mapped=$(grep -i "$last_level" "$mapping_file" | head -1 | cut -d',' -f2 | tr -d '"')
        if [ -n "$mapped" ]; then
            echo "$mapped"
            return
        fi
        
        local keywords=("litt√©rature" "romans" "jeunesse" "histoire" "science" "art" "philosophie" "m√©decine" "informatique" "cuisine" "voyage")
        for keyword in "${keywords[@]}"; do
            if [[ "${category_path,,}" =~ $keyword ]]; then
                mapped=$(grep -i "$keyword" "$mapping_file" | head -1 | cut -d',' -f2 | tr -d '"')
                if [ -n "$mapped" ]; then
                    echo "$mapped"
                    return
                fi
            fi
        done
    fi
    
    echo "Litt√©rature fran√ßaise"
}

# Fonction d'analyse du CSV g√©n√©r√©
analyze_csv() {
    local file="$1"
    local errors=0
    local warnings=0
    
    echo ""
    echo "üîç ANALYSE DU FICHIER G√âN√âR√â"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    
    # V√âRIFIER L'ENCODAGE
    echo "üìã STRUCTURE :"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    encoding=$(file -bi "$file" | cut -d'=' -f2)
    if [[ "$encoding" =~ "utf-16" ]] || [[ "$encoding" =~ "UTF-16" ]]; then
        echo "‚úÖ Encodage : UTF-16"
    else
        echo "‚ö†Ô∏è  Encodage : $encoding (UTF-16 recommand√©)"
        ((warnings++))
    fi
    
    # Convertir temporairement en UTF-8 pour l'analyse
    temp_file="/tmp/rakuten_temp_$$.csv"
    iconv -f UTF-16LE -t UTF-8 "$file" > "$temp_file" 2>/dev/null || cp "$file" "$temp_file"
    
    # COMPTER LES COLONNES
    header_cols=$(head -1 "$temp_file" | awk -F';' '{print NF}')
    data_cols=$(tail -1 "$temp_file" | awk -F';' '{print NF}')
    
    if [ "$header_cols" -eq 29 ] && [ "$data_cols" -eq 29 ]; then
        echo "‚úÖ Nombre de colonnes : 29"
    else
        echo "‚ùå Nombre de colonnes : en-t√™te=$header_cols, donn√©es=$data_cols (29 attendues)"
        ((errors++))
    fi
    
    # V√âRIFIER LES RETOURS LIGNE
    line_count=$(wc -l < "$temp_file")
    if [ "$line_count" -ne 2 ]; then
        echo "‚ùå Fichier contient $line_count lignes (2 attendues)"
        ((errors++))
    else
        echo "‚úÖ Structure : 2 lignes (en-t√™te + donn√©es)"
    fi
    
    echo ""
    echo "üìä DONN√âES OBLIGATOIRES :"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    # Lire la ligne de donn√©es
    data_line=$(tail -1 "$temp_file")
    IFS=';' read -r -a cols <<< "$data_line"
    
    # V√âRIFICATIONS D√âTAILL√âES
    checks=(
        "1:ISBN:^[0-9]{10,13}$"
        "3:Prix:^[0-9]+(\.[0-9]{1,2})?$"
        "5:Qualit√©:^(N|CN|TBE|BE|EC)$"
        "6:Quantit√©:^[1-9][0-9]{0,2}$"
        "10:Titre:.+"
        "13:Langue:^Fran√ßais$"
        "14:Auteurs:.+"
        "15:√âditeur:.+"
        "17:Classification:.+"
        "18:Poids:^[0-9]+$"
        "19:Taille:^(Petit|Moyen|Grand)$"
    )
    
    for check in "${checks[@]}"; do
        IFS=':' read -r col_num col_name pattern <<< "$check"
        value="${cols[$((col_num-1))]}"
        
        if [[ "$value" =~ $pattern ]]; then
            if [ ${#value} -gt 30 ]; then
                echo "‚úÖ Col $col_num - $col_name : ${value:0:30}..."
            else
                echo "‚úÖ Col $col_num - $col_name : $value"
            fi
        else
            echo "‚ùå Col $col_num - $col_name : '$value' (invalide)"
            ((errors++))
        fi
    done
    
    # V√âRIFIER L'IMAGE
    image="${cols[20]}"
    if [ -z "$image" ]; then
        echo "‚ö†Ô∏è  Col 21 - Image : vide"
        ((warnings++))
    elif [[ ! "$image" =~ ^https:// ]]; then
        echo "‚ùå Col 21 - Image : doit commencer par https://"
        ((errors++))
    else
        echo "‚úÖ Col 21 - Image : ${image:0:30}..."
    fi
    
    echo ""
    echo "üî§ CARACT√àRES INTERDITS :"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    # V√©rifier les caract√®res Microsoft
    bad_chars=0
    for char in ''' ''' '"' '"' '¬´' '¬ª' '‚Ä¶' '‚Äî' '‚Äì'; do
        if grep -F "$char" "$temp_file" > /dev/null 2>&1; then
            echo "‚ùå Caract√®re interdit trouv√© : $char"
            ((bad_chars++))
        fi
    done
    
    if [ $bad_chars -eq 0 ]; then
        echo "‚úÖ Aucun caract√®re Microsoft d√©tect√©"
    else
        ((errors++))
    fi
    
    rm -f "$temp_file"
    
    # R√âSULTAT
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "üìù R√âSULTAT DE L'ANALYSE :"
    
    if [ $errors -eq 0 ] && [ $warnings -eq 0 ]; then
        echo "‚úÖ FICHIER PARFAIT - Pr√™t pour Rakuten !"
        return 0
    elif [ $errors -eq 0 ]; then
        echo "‚ö†Ô∏è  $warnings avertissement(s) - Fichier utilisable"
        return 0
    else
        echo "‚ùå $errors erreur(s) √† corriger"
        return 1
    fi
}

# D√âBUT DU SCRIPT PRINCIPAL
isbn="${1:-9782070360024}"
output="rakuten_${isbn}_$(date +%Y%m%d_%H%M%S).csv"

echo "üì§ EXPORT RAKUTEN COMPLET - ISBN: $isbn"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# R√âCUP√âRER TOUTES LES DONN√âES AVEC HI√âRARCHIE DES CAT√âGORIES
echo "üìä R√©cup√©ration des donn√©es..."
all_data=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -sN -e "
WITH RECURSIVE CategoryPath AS (
    SELECT 
        tt.term_id,
        t.name,
        tt.parent,
        CAST(t.name AS CHAR(1000)) AS path,
        0 as level
    FROM wp_${SITE_ID}_posts p
    JOIN wp_${SITE_ID}_postmeta pm_isbn ON p.ID = pm_isbn.post_id AND pm_isbn.meta_key = '_isbn'
    JOIN wp_${SITE_ID}_term_relationships tr ON p.ID = tr.object_id
    JOIN wp_${SITE_ID}_term_taxonomy tt ON tr.term_taxonomy_id = tt.term_taxonomy_id AND tt.taxonomy = 'product_cat'
    JOIN wp_${SITE_ID}_terms t ON tt.term_id = t.term_id
    WHERE pm_isbn.meta_value = '$isbn'
    
    UNION ALL
    
    SELECT 
        tt.term_id,
        t.name,
        tt.parent,
        CONCAT(t.name, ' > ', cp.path) AS path,
        cp.level + 1
    FROM CategoryPath cp
    JOIN wp_${SITE_ID}_term_taxonomy tt ON cp.parent = tt.term_id AND tt.taxonomy = 'product_cat'
    JOIN wp_${SITE_ID}_terms t ON tt.term_id = t.term_id
    WHERE cp.parent > 0
)
SELECT 
    pm_isbn.meta_value as isbn,
    COALESCE(pm_title.meta_value, pm_g_title.meta_value, pm_i_title.meta_value, p.post_title) as titre,
    CAST(IFNULL(pm_price.meta_value, '0') AS DECIMAL(10,2)) as prix,
    CAST(IFNULL(pm_regular.meta_value, pm_price.meta_value) AS DECIMAL(10,2)) as prix_public,
    IFNULL(pm_condition.meta_value, 'bon') as condition_livre,
    CAST(IFNULL(pm_stock.meta_value, '1') AS UNSIGNED) as stock,
    IFNULL(pm_desc.meta_value, '') as description,
    IFNULL(pm_authors.meta_value, '') as auteurs,
    IFNULL(pm_publisher.meta_value, '') as editeur,
    IFNULL(pm_date.meta_value, '') as date_parution,
    CAST(IFNULL(pm_weight.meta_value, '200') AS UNSIGNED) as poids,
    IFNULL(pm_binding.meta_value, '') as binding,
    CAST(IFNULL(pm_pages.meta_value, '0') AS UNSIGNED) as pages,
    IFNULL(pm_image.meta_value, '') as image,
    (SELECT path FROM CategoryPath ORDER BY level DESC LIMIT 1) as wp_category,
    p.ID as post_id
FROM wp_${SITE_ID}_posts p
JOIN wp_${SITE_ID}_postmeta pm_isbn ON p.ID = pm_isbn.post_id AND pm_isbn.meta_key = '_isbn'
LEFT JOIN wp_${SITE_ID}_postmeta pm_title ON p.ID = pm_title.post_id AND pm_title.meta_key = '_best_title'
LEFT JOIN wp_${SITE_ID}_postmeta pm_g_title ON p.ID = pm_g_title.post_id AND pm_g_title.meta_key = '_g_title'
LEFT JOIN wp_${SITE_ID}_postmeta pm_i_title ON p.ID = pm_i_title.post_id AND pm_i_title.meta_key = '_i_title'
LEFT JOIN wp_${SITE_ID}_postmeta pm_price ON p.ID = pm_price.post_id AND pm_price.meta_key = '_price'
LEFT JOIN wp_${SITE_ID}_postmeta pm_regular ON p.ID = pm_regular.post_id AND pm_regular.meta_key = '_regular_price'
LEFT JOIN wp_${SITE_ID}_postmeta pm_condition ON p.ID = pm_condition.post_id AND pm_condition.meta_key = '_book_condition'
LEFT JOIN wp_${SITE_ID}_postmeta pm_stock ON p.ID = pm_stock.post_id AND pm_stock.meta_key = '_stock'
LEFT JOIN wp_${SITE_ID}_postmeta pm_desc ON p.ID = pm_desc.post_id AND pm_desc.meta_key = '_best_description'
LEFT JOIN wp_${SITE_ID}_postmeta pm_authors ON p.ID = pm_authors.post_id AND pm_authors.meta_key = '_best_authors'
LEFT JOIN wp_${SITE_ID}_postmeta pm_publisher ON p.ID = pm_publisher.post_id AND pm_publisher.meta_key = '_best_publisher'
LEFT JOIN wp_${SITE_ID}_postmeta pm_date ON p.ID = pm_date.post_id AND pm_date.meta_key = '_g_publishedDate'
LEFT JOIN wp_${SITE_ID}_postmeta pm_weight ON p.ID = pm_weight.post_id AND pm_weight.meta_key = '_calculated_weight'
LEFT JOIN wp_${SITE_ID}_postmeta pm_binding ON p.ID = pm_binding.post_id AND pm_binding.meta_key = '_best_binding'
LEFT JOIN wp_${SITE_ID}_postmeta pm_pages ON p.ID = pm_pages.post_id AND pm_pages.meta_key = '_best_pages'
LEFT JOIN wp_${SITE_ID}_postmeta pm_image ON p.ID = pm_image.post_id AND pm_image.meta_key = '_best_cover_image'
WHERE pm_isbn.meta_value = '$isbn'
LIMIT 1" 2>/dev/null)

# Parser les donn√©es
IFS=$'\t' read -r isbn titre prix prix_public condition stock description auteurs editeur date_parution poids binding pages image wp_category post_id <<< "$all_data"

# V√âRIFICATIONS DES DONN√âES OBLIGATOIRES
echo "üîç V√©rification des donn√©es obligatoires..."
errors=0

if [ -z "$isbn" ]; then
    echo "‚ùå ISBN manquant"
    ((errors++))
fi

if [ -z "$titre" ]; then
    echo "‚ùå Titre manquant"
    ((errors++))
fi

if [ -z "$prix" ] || [ "$prix" = "0" ] || [ "$prix" = "0.00" ]; then
    echo "‚ùå Prix invalide ou manquant"
    ((errors++))
fi

if [ -z "$auteurs" ]; then
    echo "‚ùå Auteurs manquants"
    ((errors++))
fi

if [ -z "$editeur" ]; then
    echo "‚ùå √âditeur manquant"
    ((errors++))
fi

if [ $errors -gt 0 ]; then
    echo ""
    echo "üõë EXPORT ANNUL√â : $errors champ(s) obligatoire(s) manquant(s)"
    echo "üí° Lancez d'abord : ./isbn_unified.sh $isbn"
    exit 1
fi

echo "‚úÖ Toutes les donn√©es obligatoires sont pr√©sentes"
echo ""

# Mapper la cat√©gorie WordPress vers Rakuten
rakuten_category=$(map_to_rakuten_category "$wp_category")
echo "üìÅ Cat√©gorie WordPress : $wp_category"
echo "üìÅ Classification Rakuten : $rakuten_category"
echo ""

# Nettoyer toutes les variables
titre=$(clean_rakuten_text "$titre")
description=$(clean_rakuten_text "$description")
auteurs=$(clean_rakuten_text "$auteurs")
editeur=$(clean_rakuten_text "$editeur")
commentaire=$(clean_rakuten_text "Envoi rapide et soign√©. Livre en $condition √©tat.")
rakuten_category=$(clean_rakuten_text "$rakuten_category")

# Mapper la condition
case "$condition" in
    "neuf") qualite="N" ;;
    "comme neuf") qualite="CN" ;;
    "tr√®s bon") qualite="TBE" ;;
    "bon") qualite="BE" ;;
    *) qualite="BE" ;;
esac

# Mapper la taille selon le binding
case "$binding" in
    *"poche"*) taille="Petit" ;;
    *"grand"*) taille="Grand" ;;
    *) taille="Moyen" ;;
esac

# Corriger l'URL de l'image (forcer https)
if [[ "$image" =~ ^http:// ]]; then
    image="${image/http:/https:}"
fi

# Description courte (200 caract√®res max)
description_courte="${description:0:200}"

# G√âN√âRER LE FICHIER CSV
echo "üìù G√©n√©ration du fichier CSV..."
{
# En-t√™te (29 colonnes)
echo "EAN / ISBN / Code produit;R√©f√©rence unique de l annonce * / Unique Advert Refence (SKU) *;Prix de vente * / Selling Price *;Prix d origine / RRP in euros;Qualit√© * / Condition *;Quantit√© * / Quantity *;Commentaire de l annonce * / Advert comment *;Commentaire priv√© de l annonce / Private Advert Comment;Type de Produit * / Type of Product *;Titre * / Title *;Description courte * / Short Description *;R√©sum√© du Livre ou Revue;Langue;Auteurs;Editeur;Date de parution;Classification Th√©matique;Poids en grammes / Weight in grammes;Taille / Size;Nombre de Pages / Number of pages;URL Image principale * / Main picture *;URLs Images Secondaires / Secondary Picture;Code op√©ration promo / Promotion code;Colonne vide / void column;Description Annonce Personnalis√©e;Exp√©dition, Retrait / Shipping, Pick Up;T√©l√©phone / Phone number;Code postale / Zip Code;Pays / Country"

# Donn√©es (29 colonnes) - SANS HTML
echo -n "$isbn;"                    # 1
echo -n "$isbn;"                    # 2
echo -n "$prix;"                    # 3
echo -n "$prix_public;"             # 4
echo -n "$qualite;"                 # 5
echo -n "$stock;"                   # 6
echo -n "$commentaire;"             # 7
echo -n ";"                         # 8
echo -n "Livre;"                    # 9
echo -n "$titre;"                   # 10
echo -n "$description_courte;"      # 11
echo -n "$description;"             # 12
echo -n "Fran√ßais;"                 # 13
echo -n "$auteurs;"                 # 14
echo -n "$editeur;"                 # 15
echo -n "$date_parution;"           # 16
echo -n "$rakuten_category;"        # 17
echo -n "$poids;"                   # 18
echo -n "$taille;"                  # 19
echo -n "$pages;"                   # 20
echo -n "$image;"                   # 21
echo -n ";"                         # 22
echo -n ";"                         # 23
echo -n ";"                         # 24
echo -n ";"                         # 25 (pas de HTML)
echo -n "EXP / RET;"               # 26
echo -n "0668563512;"              # 27
echo -n "76000;"                   # 28
echo "France"                       # 29
} > "${output}.tmp"

# Convertir en UTF-16LE (recommand√© par Rakuten)
iconv -f UTF-8 -t UTF-16LE "${output}.tmp" > "$output"
rm -f "${output}.tmp"

echo ""
echo "‚úÖ Export cr√©√© : $output"
echo ""
echo "üìã INFORMATIONS DU FICHIER :"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo "Format : CSV avec point-virgule"
echo "Encodage : UTF-16LE (recommand√©)"
echo "Colonnes : 29"
echo "Titre : $titre"
echo "Prix : $prix ‚Ç¨"
echo "Classification : $rakuten_category"

# LANCER L'ANALYSE AUTOMATIQUEMENT
if analyze_csv "$output"; then
    echo ""
    echo "üöÄ FICHIER PR√äT POUR UPLOAD SUR RAKUTEN !"
else
    echo ""
    echo "‚ö†Ô∏è  Corrigez les erreurs avant upload"
fi
